{% extends 'base.html' %}

{% block title %}Карта компаний{% endblock %}

{% block content %}
{% include 'includes/page_header.html' with title='Карта компаний' show_back_button=True %}

<div class="section">
    {% if error %}
    {% include 'includes/alert.html' with alert_type='error' message=error %}
    {% else %}
    <div id="map" style="width: 100%; height: 75vh;"></div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% if not error %}
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_api_key }}&lang=ru_RU"></script>
<script type="text/javascript">
    ymaps.ready(init);

    function init() {
        var myMap = new ymaps.Map("map", {
            center: [55.76, 37.64],
            zoom: 10
        });

        var companies = JSON.parse('{{ companies_json|escapejs }}');
        var myCollection = new ymaps.GeoObjectCollection();

        if (companies.length === 0) {
            myMap.setCenter([55.76, 37.64], 5);
            return;
        }

        for (var i = 0; i < companies.length; i++) {
            var company = companies[i];
            var placemark = new ymaps.Placemark([company.lat, company.lon], {
                balloonContentHeader: company.title,
                balloonContentBody: company.address,
                hintContent: company.title
            });
            myCollection.add(placemark);
        }

        myMap.geoObjects.add(myCollection);

        myMap.setBounds(myCollection.getBounds(), {
            checkZoomRange: true,
            zoomMargin: 35
        });
    }
</script>
{% endif %}
{% endblock %}