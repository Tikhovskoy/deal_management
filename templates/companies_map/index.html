{% extends 'base.html' %}
{% load static %}

{% block title %}Карта компаний{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/companies_map.css' %}">
{% endblock %}

{% block content %}
{% include 'includes/page_header.html' with title='Карта компаний' show_back_button=True %}

<div class="section">
    {% if error %}
    {% include 'includes/alert.html' with alert_type='error' message=error %}
    {% else %}
    <div id="map" style="width: 100%; height: 75vh;"></div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% if not error %}
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_api_key }}&lang=ru_RU"></script>
<script type="text/javascript">
    ymaps.ready(init);

    function init() {
        var myMap = new ymaps.Map("map", {
            center: [55.76, 37.64],
            zoom: 10
        });

        var companies = JSON.parse('{{ companies_json|escapejs }}');
        var myCollection = new ymaps.GeoObjectCollection();

        if (companies.length === 0) {
            myMap.setCenter([55.76, 37.64], 5);
            return;
        }

        var pulsatingLayout = ymaps.templateLayoutFactory.createClass(
            '<div class="placemark-dot"></div>'
        );

        for (var i = 0; i < companies.length; i++) {
            var company = companies[i];
            var placemark = new ymaps.Placemark([company.lat, company.lon], {
                balloonContentHeader: company.title,
                balloonContentBody: company.address,
                hintContent: company.title
            }, {
                iconLayout: pulsatingLayout,
                iconShape: {
                    type: 'Circle',
                    coordinates: [0, 0],
                    radius: 15
                }
            });
            myCollection.add(placemark);
        }

        myMap.geoObjects.add(myCollection);

        if (myCollection.getLength() === 1) {
            myMap.setCenter(myCollection.get(0).geometry.getCoordinates(), 12);
        } else if (myCollection.getLength() > 1) {
            myMap.setBounds(myCollection.getBounds(), {
                checkZoomRange: true,
                zoomMargin: 35
            });
        }
    }
</script>
{% endif %}
{% endblock %}