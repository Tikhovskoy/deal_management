{% extends 'base.html' %}
{% load deal_filters %}

{% block title %}Управление сделками - Bitrix24{% endblock %}

{% block content %}
{% include 'includes/page_header.html' with title='Управление сделками Bitrix24' show_back_button=True %}

<div class="section">
    <h2>10 последних активных сделок</h2>
    {% if deals %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Название</th>
                <th>Стадия</th>
                <th>Сумма</th>
            </tr>
        </thead>
        <tbody>
            {% for deal in deals %}
            <tr>
                <td>{{ deal.ID }}</td>
                <td>{{ deal.TITLE }}</td>
                <td>{{ deal.STAGE_ID|translate_stage }}</td>
                <td class="amount">{{ deal.OPPORTUNITY|default:"0" }} {{ deal.CURRENCY_ID|default:"RUB" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="no-data">
        Нет активных сделок
    </div>
    {% endif %}
</div>

<div class="section">
    <h2>Создать новую сделку</h2>

    {% if success_message %}
        {% include 'includes/alert.html' with alert_type='success' message=success_message %}
    {% endif %}

    {% if error_message %}
        {% include 'includes/alert.html' with alert_type='error' message=error_message %}
    {% endif %}

    <form method="POST" action="{% url 'deals:index' %}?DOMAIN={{ request.GET.DOMAIN }}&PROTOCOL={{ request.GET.PROTOCOL }}&LANG={{ request.GET.LANG }}&APP_SID={{ request.GET.APP_SID }}">
        {% csrf_token %}

        <div class="form-group">
            <label for="title">Название сделки <span class="required">*</span></label>
            <input type="text" id="title" name="title" required>
        </div>

        <div class="form-group">
            <label for="{{ custom_field_name }}">Источник лида <span class="required">*</span></label>
            <select id="{{ custom_field_name }}" name="{{ custom_field_name }}" required>
                <option value="">Выберите источник...</option>
                {% for option in lead_source_options %}
                    <option value="{{ option.ID }}">{{ option.VALUE }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="opportunity">Сумма (руб.)</label>
            <input type="number" id="opportunity" name="opportunity" step="0.01" min="0" placeholder="0.00">
        </div>

        <button type="submit" class="btn btn-primary">Создать сделку</button>
    </form>
</div>
{% endblock %}
