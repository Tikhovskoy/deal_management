{% extends 'base.html' %}
{% load deal_filters %}

{% block title %}Управление сделками - Bitrix24{% endblock %}

{% block content %}
<div class="header">
    <h1>Управление сделками Bitrix24</h1>
    <div class="user-info">
        <p class="success">✓ Авторизация успешна!</p>
        <p>Добро пожаловать, <strong>{{ user_name }}</strong>!</p>
    </div>
</div>

<div class="section">
    <h2>10 последних активных сделок</h2>
    {% if deals %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Название</th>
                <th>Стадия</th>
                <th>Сумма</th>
            </tr>
        </thead>
        <tbody>
            {% for deal in deals %}
            <tr>
                <td>{{ deal.ID }}</td>
                <td>{{ deal.TITLE }}</td>
                <td>{{ deal.STAGE_ID|translate_stage }}</td>
                <td class="amount">{{ deal.OPPORTUNITY|default:"0" }} {{ deal.CURRENCY_ID|default:"RUB" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="no-data">
        Нет активных сделок
    </div>
    {% endif %}
</div>

<div class="section">
    <h2>Создать новую сделку</h2>

    {% if success_message %}
    <div class="alert alert-success">
        {{ success_message }}
    </div>
    {% endif %}

    {% if error_message %}
    <div class="alert alert-error">
        {{ error_message }}
    </div>
    {% endif %}

    <form method="POST" action="?DOMAIN={{ request.GET.DOMAIN }}&PROTOCOL={{ request.GET.PROTOCOL }}&LANG={{ request.GET.LANG }}&APP_SID={{ request.GET.APP_SID }}">
        {% csrf_token %}

        <div class="form-group">
            <label for="title">Название сделки <span class="required">*</span></label>
            <input type="text" id="title" name="title" required>
        </div>

        <div class="form-group">
            <label for="{{ custom_field_name }}">Источник лида <span class="required">*</span></label>
            <select id="{{ custom_field_name }}" name="{{ custom_field_name }}" required>
                <option value="">Выберите источник...</option>
                <option value="44">Сайт</option>
                <option value="46">Телефон</option>
                <option value="48">Email</option>
                <option value="50">Реклама</option>
            </select>
        </div>

        <div class="form-group">
            <label for="opportunity">Сумма (руб.)</label>
            <input type="number" id="opportunity" name="opportunity" step="0.01" min="0" placeholder="0.00">
        </div>

        <button type="submit" class="btn btn-primary">Создать сделку</button>
    </form>
</div>
{% endblock %}
