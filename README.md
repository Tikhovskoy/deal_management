# Bitrix24 Apps

Это Django-проект, предоставляющий набор локальных приложений для Bitrix24. Проект предназначен для локального запуска и доступа через портал Bitrix24. Он использует базу данных PostgreSQL и `ngrok` для предоставления доступа к локальному серверу через интернет.

## Приложения

Проект состоит из нескольких приложений Django, каждое из которых предоставляет определенную функциональность:

*   **Home:** Главная страница, на которой отображается список доступных приложений.
*   **Deal Management:** Позволяет пользователям просматривать и создавать сделки в Bitrix24.
*   **Product QR Generator:** Генерирует QR-коды для товаров с публичными секретными ссылками.
*   **Employee Hierarchy:** Отображает иерархию сотрудников и статистику звонков.
*   **Companies Map:** Визуализирует адреса компаний на интерактивной карте.
*   **Contact Manager:** Импортирует и экспортирует контакты из/в файлы CSV и XLSX.

Проект использует собственный механизм аутентификации для аутентификации пользователей с их учетной записью Bitrix24. Он также использует подмодуль `integration_utils` для работы с API Bitrix24.

## Требования

- Python 3.12+
- PostgreSQL 12+
- ngrok (для локальной разработки)
- Bitrix24 аккаунт с правами на создание локальных приложений

## Сборка и запуск

Для сборки и запуска этого проекта вам понадобятся Python 3.12+, PostgreSQL 12+ и `ngrok`.

1.  **Клонируйте репозиторий:**

    ```bash
    git clone <repository-url>
    cd deal_management
    git submodule update --init --recursive
    ```

2.  **Создайте виртуальное окружение и установите зависимости:**

    ```bash
    python -m venv venv
    # Для Windows
    venv\Scripts\activate
    # Для Linux/Mac
    source venv/bin/activate
    pip install -r requirements.txt
    ```

3.  **Настройте базу данных:**

    Создайте базу данных PostgreSQL с именем `bitrix_deals`.

4.  **Настройте переменные окружения:**

    Скопируйте файл `.env.example` в `.env` и заполните необходимые значения, включая учетные данные API Bitrix24, учетные данные базы данных и URL-адрес `ngrok`.

5.  **Примените миграции базы данных:**

    ```bash
    python manage.py migrate
    ```

6.  **Запустите сервер разработки:**

    ```bash
    python manage.py runserver
    ```

7.  **Запустите ngrok:**

    В отдельном терминале выполните `ngrok http 8000`, чтобы предоставить доступ к локальному серверу через интернет. Обновите `NGROK_URL` в вашем файле `.env`, указав URL-адрес `ngrok`.

## Соглашения по разработке

*   Проект соответствует стандартной структуре проектов Django, где каждое приложение находится в своем собственном каталоге в папке `apps`.
*   Проект использует `python-dotenv` для управления переменными окружения. Все секреты и конфигурации, которые могут отличаться в разных средах, должны храниться в файле `.env`.
*   Проект использует кастомный декоратор `smart_auth` для обработки аутентификации с Bitrix24.
*   Подмодуль `integration_utils` используется для всех взаимодействий с API Bitrix24.
*   Каждое приложение имеет свой собственный файл `urls.py`, который включается в основной файл `config/urls.py`.
*   Шаблоны хранятся в каталоге `templates` с подкаталогом для каждого приложения.
*   Статические файлы хранятся в каталоге `static`.

## Структура проекта

```
deal_management/
├── config/              # Настройки Django
│   ├── settings.py
│   ├── urls.py
│   ├── middleware.py    # Кастомные middleware (ngrok warning bypass)
│   └── wsgi.py
├── apps/                # Django приложения
│   ├── home/            # Главная страница с выбором приложений
│   ├── deals/           # Управление сделками
│   ├── product_qr/      # QR-коды для товаров
│   ├── employees/       # Иерархия сотрудников
│   ├── companies_map/   # Карта компаний
│   └── contact_manager/ # Управление контактами
├── templates/           # HTML шаблоны
│   ├── base.html
│   ├── home/
│   ├── deals/
│   ├── product_qr/
│   ├── employees/
│   ├── companies_map/
│   └── contact_manager/
├── static/              # Статические файлы
├── integration_utils/   # Submodule для работы с Bitrix24
├── .env
├── .env.example
├── manage.py
└── requirements.txt
```

## Устранение неполадок

### Ошибка 403 Forbidden

Проверьте настройки:
- Домен Bitrix24 добавлен в `CSRF_TRUSTED_ORIGINS`
- Cookie включены в браузере
- URL приложения корректен в настройках Bitrix24

### Приложение не открывается в Bitrix24

Убедитесь что:
- ngrok запущен и URL актуален
- URL в настройках приложения Bitrix24 совпадает с ngrok URL
- Домен ngrok добавлен в `ALLOWED_HOSTS`

### Expired token

При истечении токена закройте и откройте приложение заново в Bitrix24 для получения нового токена.

### Кастомное поле не сохраняется

Проверьте:
- Поле создано в Bitrix24
- Символьный код поля указан корректно в `CUSTOM_FIELD_NAME`
- Значения опций соответствуют ID из списка Bitrix24

### Отсутствует BITRIX_SALT

Если в `.env` не указан `BITRIX_SALT`, приложение использует `SECRET_KEY` (fallback для обратной совместимости). Для продакшена рекомендуется создать отдельный `BITRIX_SALT`:

```bash
python -c "import secrets; print(secrets.token_urlsafe(50))"
```

### QR-код не открывает страницу товара

Проверьте:
- URL ngrok актуален и доступен извне
- Переменная `NGROK_URL` в `.env` обновлена
- Домен ngrok добавлен в `ALLOWED_HOSTS` и `CSRF_TRUSTED_ORIGINS`
- Webhook `BITRIX_WEBHOOK_URL` настроен корректно

### Публичная страница товара не загружается

Убедитесь что:
- Webhook имеет права на чтение CRM
- В модели ProductQR сохранены данные товара (`product_data`)
- UUID в URL корректный и существует в базе данных

### Изображения товара не отображаются

Приложение ищет изображения в следующем порядке:
1. `PREVIEW_PICTURE` - основное изображение
2. `DETAIL_PICTURE` - детальное изображение
3. `PROPERTY_*` - кастомные поля с типом файл

Если изображения не отображаются, проверьте что они загружены в карточку товара в Bitrix24.

## Лицензия

MIT